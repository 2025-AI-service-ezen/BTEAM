{% extends "layout.html" %}

{% block title %}í™ˆ - UP & down{% endblock %}

{% block content %}
    {% if session.get('user') %}
        <p>{{ session.get('user') }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</p>
    {% else %}
        <p>ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    {% endif %}

<!-- ğŸ” ê²€ìƒ‰ ì„¹ì…˜ -->
<div class="search-section">
  <form method="POST" action="{{ url_for('stocks_search_bp.search') }}" onsubmit="return checkLogin();" autocomplete="off">
    <div class="search-line">
      <input
        type="text"
        id="indexSearchInput"
        name="search"
        placeholder="ì¢…ëª©ëª… ê²€ìƒ‰"
        {% if not session.get('user') %}disabled{% endif %}
      >
      <button type="submit" class="btn btn-primary" {% if not session.get('user') %}disabled{% endif %}>ê²€ìƒ‰</button>
  </form>
</div>
<div id="indexAutocompleteList"></div>

    <!-- ğŸ“Œ ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì„ í˜¸ ì£¼ì‹ ìŠ¬ë¼ì´ë“œ íŒì—… ì´ ë¶€ë¶„ì¶”ê°€ë¨ -->
    <div id="preferPopup" class="prefer-popup">
        <div class="prefer-popup-header">
            <span>ğŸ“Š ì„ í˜¸ ì£¼ì‹ ì„¤ì •</span>
            <button id="preferPopupClose" class="prefer-popup-close">âœ–</button>
        </div>
        <div class="prefer-popup-body">
            {% include 'prefer_stock.html' %}
        </div>
    </div>

    <!-- ğŸ“ˆ ìƒìŠ¹/í•˜ë½ ì¹´ë“œ -->
    <div class="card" style="margin-top: 40px;">
        <div class="card-header">ğŸ“ˆ ìƒìŠ¹ ğŸ“‰ í•˜ë½</div>
        <div class="card-body">
        <div class="row">
            <!-- ìƒìŠ¹ -->
            <div class="col">
            <div class="section-title up">ìƒìŠ¹ ì¢…ëª©</div>
            <div class="chart-box"><canvas id="chart-up"></canvas></div>
            <div class="news-box">
                <strong>ğŸ“¢ ìƒìŠ¹ ë‰´ìŠ¤:</strong>
                <p>{{ up_news }}</p>
            </div>
            </div>
            <!-- í•˜ë½ -->
            <div class="col">
            <div class="section-title down">í•˜ë½ ì¢…ëª©</div>
            <div class="chart-box"><canvas id="chart-down"></canvas></div>
            <div class="news-box">
                <strong>ğŸ“‰ í•˜ë½ ë‰´ìŠ¤:</strong>
                <p>{{ down_news }}</p>
            </div>
            </div>
        </div>
        </div>
    </div>

<!-- ğŸ“Š ê±°ë˜ëŸ‰ TOP5 & AI ì¶”ì²œ ë¦¬í¬íŠ¸ -->
<div class="row" style="margin-top: 150px;">
    <!-- ê±°ë˜ëŸ‰ ì°¨íŠ¸ -->
    <div class="col">
        <div class="card">
        <div class="card-header secondary flex-between">
            <span>ì¸ê¸° ì£¼ì‹ ë™í–¥</span>
            <button id="showTop20Btn" class="btn btn-outline" {% if not session.get('user') %}disabled{% endif %}>
            ê±°ë˜ëŸ‰ TOP20
        </button>
        </div>
        <canvas id="volumeChart"></canvas>
        </div>
    </div>

    <!-- AI ì¶”ì²œ ë¦¬í¬íŠ¸ -->
    <div class="col">
        <div class="card">
        <div class="card-header secondary">ğŸ¤– AI ì¶”ì²œ ë¦¬í¬íŠ¸</div>
        <div class="card-body">
            <ul>
            {% for report in ai_reports %}
                <li>{{ report }}</li>
            {% endfor %}
            </ul>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>

    <script>
        const isLogin = {{ 'true' if session.get('user') else 'false' }};
        const chartData = {{ initial_stocks_json | safe }};
        const labels = chartData.map(item => item['ì¢…ëª©ëª…']);
        const volumes = chartData.map(item => item['ê±°ë˜ëŸ‰']);

        // ê±°ë˜ëŸ‰ TOP5 ì°¨íŠ¸
        const ctx = document.getElementById('volumeChart').getContext('2d');
        const volumeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
            label: 'ìµœëŒ€ ê±°ë˜ëŸ‰',
            data: volumes,
            backgroundColor: 'skyblue',
            }]
        },
        options: {
            onClick: (e, activeElements) => {
            if (!isLogin) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            if (activeElements.length > 0) {
                const index = activeElements[0].index;
                const selectedStock = labels[index];
                window.location.href = `/search?search=${encodeURIComponent(selectedStock)}`;
            } else {
                openTop20Popup();
            }
            },
            scales: {
            y: { beginAtZero: true }
            }
        }
        });

        document.getElementById('showTop20Btn').addEventListener('click', () => {
        if (!isLogin) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        openTop20Popup();
        });

        function openTop20Popup() {
        window.open('/popup_chart', 'ê±°ë˜ëŸ‰ ìƒìœ„ 20ìœ„', 'width=800,height=600');
        }

        function checkLogin() {
        if (!isLogin) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return false;
        }
        return true;
        }

        document.addEventListener("DOMContentLoaded", () => {
            setupAutocomplete("indexSearchInput", "indexAutocompleteList", "/autocomplete");
        
            // ì´ ì•„ë˜ë¡œ ìˆ˜ì •ë¨
            const popup = document.getElementById('preferPopup');
            const openBtn = document.getElementById('preferToggle');
            const closeBtn = document.getElementById('preferPopupClose');

            openBtn.addEventListener('click', () => {
            popup.style.display = 'flex';
            });

            closeBtn.addEventListener('click', () => {
            popup.style.display = 'none';
            });

            // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (ì„ íƒ)
            window.addEventListener('click', (event) => {
            if (event.target === popup) {
                popup.style.display = 'none';
            }
            });
        });
    </script>
{% endblock %}
